{% extends 'base.html' %}

{% block title %}Book a Table - Little Lemon{% endblock %}

{% block content %}
<section style="background: #f8f9fa; padding: 3rem 0;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
        <div style="background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden;">
            
            <!-- Header -->
            <div style="background: #495e57; color: white; padding: 2rem; text-align: center;">
                <h1 style="font-family: 'Markazi Text', serif; font-size: 3rem; margin-bottom: 0.5rem; color: #f4ce14;">Book Your Table</h1>
                <p style="font-size: 1.1rem; opacity: 0.9;">Reserve your spot at Little Lemon today</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; min-height: 500px;">
                
                <!-- Booking Form -->
                <div style="padding: 2rem; background: white;">
                    <h2 style="font-family: 'Markazi Text', serif; font-size: 2rem; color: #495e57; margin-bottom: 1.5rem;">Reservation Details</h2>
                    
                    <form method="post" id="booking-form">
                        {% csrf_token %}
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                                <i class="fas fa-user" style="color: #f4ce14; margin-right: 0.5rem;"></i>
                                First Name
                            </label>
                            {{ form.first_name }}
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                                <i class="fas fa-calendar" style="color: #f4ce14; margin-right: 0.5rem;"></i>
                                Reservation Date
                            </label>
                            {{ form.reservation_date }}
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                                <i class="fas fa-clock" style="color: #f4ce14; margin-right: 0.5rem;"></i>
                                Reservation Time
                            </label>
                            {{ form.reservation_slot }}
                        </div>

                        <button type="submit" id="submit-btn" style="width: 100%; background: #f4ce14; color: #333; padding: 1rem; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
                            Book Table
                        </button>
                    </form>
                </div>

                <!-- Current Reservations -->
                <div style="padding: 2rem; background: #f8f9fa; border-left: 1px solid #e0e0e0;">
                    <h3 style="font-family: 'Markazi Text', serif; font-size: 1.8rem; color: #495e57; margin-bottom: 1.5rem;">
                        <i class="fas fa-list" style="color: #f4ce14; margin-right: 0.5rem;"></i>
                        Current Reservations
                    </h3>
                    <div id="reservations-list">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <div class="loading" style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f4ce14; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div>
                            <p>Loading reservations...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Slots Visualization -->
            <div style="padding: 2rem; background: white; border-top: 1px solid #e0e0e0;">
                <h3 style="font-family: 'Markazi Text', serif; font-size: 1.8rem; color: #495e57; margin-bottom: 1.5rem;">
                    <i class="fas fa-clock" style="color: #f4ce14; margin-right: 0.5rem;"></i>
                    Available Time Slots
                </h3>
                <div id="time-slots-visual" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div style="background: #e8f4f8; padding: 1rem; border-radius: 8px; font-size: 0.9rem; color: #495e57;">
                    <i class="fas fa-info-circle" style="color: #f4ce14; margin-right: 0.5rem;"></i>
                    <strong>Legend:</strong> 
                    <span style="color: #28a745; margin-left: 1rem;">●</span> Available
                    <span style="color: #dc3545; margin-left: 1rem;">●</span> Booked
                    <span style="color: #f4ce14; margin-left: 1rem;">●</span> Selected
                </div>
            </div>
        </div>
    </div>
</section>

<style>
/* Form Styling */
.form-control, input[type="text"], input[type="date"], select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    font-family: 'Karla', sans-serif;
}

.form-control:focus, input:focus, select:focus {
    outline: none;
    border-color: #f4ce14;
    box-shadow: 0 0 0 3px rgba(244, 206, 20, 0.1);
}

.time-slot {
    padding: 0.75rem;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    font-weight: 500;
}

.time-slot.available {
    border-color: #28a745;
    background: #28a745;
    color: white;
}

.time-slot.booked {
    border-color: #dc3545;
    background: #dc3545;
    color: white;
    cursor: not-allowed;
    opacity: 0.7;
}

.time-slot.selected {
    border-color: #f4ce14;
    background: #f4ce14;
    color: #333;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Mobile Responsive */
@media (max-width: 768px) {
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    div[style*="border-left: 1px solid #e0e0e0"] {
        border-left: none !important;
        border-top: 1px solid #e0e0e0 !important;
    }
}
</style>

<script>
let selectedSlot = null;

// Set current date as default and load reservations
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[type="date"]');
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    
    loadReservations(today);
    createTimeSlotsVisual();
    
    // Update reservations when date changes
    dateInput.addEventListener('change', function() {
        loadReservations(this.value);
    });

    // Form submission with loading state
    const form = document.getElementById('booking-form');
    const submitBtn = document.getElementById('submit-btn');
    
    form.addEventListener('submit', function() {
        submitBtn.innerHTML = '<div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #333; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 0.5rem;"></div>Booking...';
        submitBtn.disabled = true;
    });
});

function loadReservations(date) {
    const container = document.getElementById('reservations-list');
    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><div class="loading" style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f4ce14; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div><p>Loading...</p></div>';
    
    fetch(`/bookings/?date=${date}`)
        .then(response => response.json())
        .then(data => {
            updateTimeSlots(data.bookings);
            displayReservations(data.bookings, date);
            updateTimeSlotsVisual(data.bookings);
        })
        .catch(error => {
            container.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px;"><i class="fas fa-exclamation-triangle"></i> Error loading reservations</div>';
        });
}

function updateTimeSlots(bookings) {
    const timeSelect = document.querySelector('select[name="reservation_slot"]');
    const bookedSlots = bookings.map(booking => booking.reservation_slot);
    
    Array.from(timeSelect.options).forEach(option => {
        if (bookedSlots.includes(parseInt(option.value))) {
            option.disabled = true;
            option.style.backgroundColor = '#f8d7da';
            option.style.color = '#721c24';
        } else {
            option.disabled = false;
            option.style.backgroundColor = '';
            option.style.color = '';
        }
    });
}

function displayReservations(bookings, date) {
    const container = document.getElementById('reservations-list');
    
    if (bookings.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
                <i class="fas fa-calendar-times" style="font-size: 3rem; color: #f4ce14; margin-bottom: 1rem; display: block;"></i>
                <h4 style="margin-bottom: 0.5rem;">No bookings</h4>
                <p>No reservations found for ${date}</p>
            </div>
        `;
        return;
    }
    
    let html = '<div style="background: white; border-radius: 8px; overflow: hidden;"><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f8f9fa;"><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #495e57;"><i class="fas fa-user"></i> Name</th><th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #495e57;"><i class="fas fa-clock"></i> Time</th></tr></thead><tbody>';
    bookings.forEach((booking, index) => {
        html += `<tr style="border-bottom: 1px solid #e1e5e9; ${index % 2 === 0 ? 'background: #f9f9f9;' : ''}"><td style="padding: 0.75rem; font-weight: 500;">${booking.first_name}</td><td style="padding: 0.75rem;">${booking.reservation_slot}:00</td></tr>`;
    });
    html += '</tbody></table></div>';
    
    container.innerHTML = html;
}

function createTimeSlotsVisual() {
    const container = document.getElementById('time-slots-visual');
    const timeSlots = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
    const timeLabels = ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM', '6:00 PM', '7:00 PM', '8:00 PM'];
    
    container.innerHTML = '';
    
    timeSlots.forEach((slot, index) => {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'time-slot available';
        slotDiv.textContent = timeLabels[index];
        slotDiv.dataset.slot = slot;
        
        slotDiv.addEventListener('click', function() {
            if (!this.classList.contains('booked')) {
                // Remove previous selection
                document.querySelectorAll('.time-slot.selected').forEach(el => {
                    el.classList.remove('selected');
                    el.classList.add('available');
                });
                
                // Select this slot
                this.classList.remove('available');
                this.classList.add('selected');
                selectedSlot = slot;
                
                // Update form select
                const select = document.querySelector('select[name="reservation_slot"]');
                select.value = slot;
            }
        });
        
        container.appendChild(slotDiv);
    });
}

function updateTimeSlotsVisual(bookings) {
    const bookedSlots = bookings.map(booking => booking.reservation_slot);
    
    document.querySelectorAll('.time-slot').forEach(slot => {
        const slotNumber = parseInt(slot.dataset.slot);
        
        slot.classList.remove('available', 'booked', 'selected');
        
        if (bookedSlots.includes(slotNumber)) {
            slot.classList.add('booked');
        } else {
            slot.classList.add('available');
        }
    });
}
</script>
{% endblock %}
